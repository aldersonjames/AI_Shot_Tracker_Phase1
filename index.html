<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="theme-color" content="#0b0b0d" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>AI SHOT TRACKER</title>

  <link rel="manifest" href="manifest.webmanifest?v=18" />
  <link rel="apple-touch-icon" href="assets/icon-512.png?v=18" />
  <link rel="preload" href="style.css?v=15" as="style" />
  <link rel="stylesheet" href="style.css?v=15" />

  <script>window.__AUTO_LOGGER__ = false;</script>
  <script type="module" src="logger.js?v=15"></script>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script defer src="bundle.js?v=18"></script>

  <style>
    /* Keep full target visible */
    .camera-wrap { position: relative; width: 100%; height: calc(100vh - 140px); background:#000; }
    #liveVideo { width:100%; height:100%; object-fit:contain; background:#000; }
    #liveOverlay { position:absolute; inset:0; }

    /* Tiny overflow menu in header (replaces bottom log dock) */
    .menu-wrap { position: relative; display:inline-block; }
    .menu { position:absolute; right:0; top:36px; min-width:160px;
            background:#141416; border:1px solid #2a2b2f; border-radius:10px; padding:6px;
            box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:60; }
    .menu.hidden { display:none; }
    .menu button { width:100%; text-align:left; padding:8px 10px; background:transparent; border:none; color:#e8e8ee; border-radius:8px; }
    .menu button:hover { background:#1c1d22; }

    /* Splash is already styled in style.css; ensure it's top-most */
    #splash { z-index: 100; }
  </style>
</head>
<body class="theme-dark">
  <!-- Splash (always show ≥ 3s) -->
  <section class="screen active" id="splash" aria-label="Loading">
    <div class="logo-wrap">
      <svg viewBox="0 0 64 64" class="logo" role="img" aria-label="Target logo">
        <defs>
          <radialGradient id="g" cx="50%" cy="50%">
            <stop offset="0%" stop-color="#ff2b2b"/>
            <stop offset="100%" stop-color="#b10000"/>
          </radialGradient>
        </defs>
        <circle cx="32" cy="32" r="31" fill="none" stroke="url(#g)" stroke-width="2"/>
        <circle cx="32" cy="32" r="20" fill="none" stroke="#ff2b2b" stroke-width="2" opacity="0.7"/>
        <circle cx="32" cy="32" r="10" fill="none" stroke="#ff2b2b" stroke-width="2" opacity="0.4"/>
        <circle cx="32" cy="32" r="2"  fill="#ff2b2b"/>
      </svg>
      <h1>AI SHOT TRACKER</h1>
      <div class="progress"><span></span></div>
    </div>
    <footer class="splash-foot">Preparing camera…</footer>
  </section>

  <!-- Setup -->
  <section class="screen" id="setup" aria-label="Quick Setup">
    <header class="topbar"><h2>Quick Setup</h2></header>
    <div class="panel glass">
      <div class="grid">
        <label class="field">
          <span>Group label</span>
          <input id="groupLabel" type="text" placeholder="e.g., 5-shot 100 yd" />
        </label>
        <label class="field">
          <span>Distance</span>
          <input id="distanceVal" type="number" step="0.1" value="100" />
        </label>
        <label class="field">
          <span>Units</span>
          <select id="units">
            <option value="yards">yards</option>
            <option value="meters">meters</option>
          </select>
        </label>
        <label class="field">
          <span>Camera</span>
          <select id="cameraFacing">
            <option value="environment">Rear</option>
            <option value="user">Front</option>
          </select>
        </label>
      </div>

      <div class="panel glass" style="margin-top:12px">
        <h3 style="margin:0 0 8px">Test Media</h3>
        <div class="grid">
          <label class="field">
            <span>Local file (MP4 / PNG / JPG)</span>
            <input id="testMedia" type="file" accept="video/mp4,image/*" />
          </label>
        </div>
        <div class="actions">
          <button class="btn" id="useTestMedia">Use Test Media</button>
          <button class="btn btn-ghost" id="useLiveCamera">Use Live Camera</button>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button class="btn btn-primary" id="toCalTags">Go Live</button>
      </div>
    </div>
  </section>

  <!-- Hidden legacy screens kept for compatibility -->
  <section class="screen" id="cal-tags" style="display:none"></section>
  <section class="screen" id="cal-ring" style="display:none"></section>

  <!-- Live -->
  <section class="screen" id="live" aria-label="Live HUD">
    <header class="topbar">
      <h2>Live</h2>
      <div class="top-actions">
        <button class="icon-btn" id="startSession" title="Start session (capture baseline)">▶︎</button>
        <button class="icon-btn" id="endSession"   title="End session">■</button>
        <button class="icon-btn" id="toggleDetect" title="Toggle detection">AI</button>
        <button class="icon-btn" id="toggleStab"   title="Toggle stabilization">Stab</button>
        <button class="icon-btn" id="togglePlay"   title="Play/Pause test video">Vid</button>
        <button class="icon-btn" id="toggleTrails" title="Toggle shot trails">≡</button>
        <button class="icon-btn" id="toggleROI"    title="Draw/clear ROI">□</button>
        <button class="icon-btn" id="manualShot"   title="Add shot manually">+</button>
        <button class="icon-btn" id="endGroup"     title="Complete group">✓</button>

        <!-- Overflow menu (logs etc.) -->
        <span class="menu-wrap">
          <button class="icon-btn" id="menuBtn" title="More">⋮</button>
          <div class="menu hidden" id="overflowMenu">
            <button id="menuToggleLogs">Show/Hide Logs</button>
            <button id="menuDownloadLog">Download Logs</button>
            <button id="menuCopyLog">Copy Logs</button>
            <button id="menuClearLog">Clear Logs</button>
          </div>
        </span>
      </div>
    </header>

    <div class="camera-wrap">
      <video id="liveVideo" playsinline autoplay muted></video>
      <canvas id="liveOverlay"></canvas>
      <div class="hud">
        <div class="stat"><span class="label">Shots</span><span class="value" id="shotCount">0</span></div>
        <div class="stat"><span class="label">Group</span><span class="value" id="groupInches">—</span></div>
        <div class="stat"><span class="label">MOA</span><span class="value" id="groupMOA">—</span></div>
      </div>
      <div class="banner hidden" id="completeBanner">Group Complete</div>
    </div>

    <div class="dock">
      <button class="btn btn-ghost" id="undoShot">Undo</button>
      <button class="btn btn-danger" id="resetGroup">Reset</button>
      <button class="btn btn-primary" id="snapBtn">Snapshot</button>
    </div>
  </section>

  <!-- Review -->
  <section class="screen" id="review" aria-label="Review & Export">
    <header class="topbar"><h2>Review & Export</h2></header>
    <div class="panel glass">
      <figure class="snapshot">
        <canvas id="reviewCanvas"></canvas>
        <figcaption id="reviewCaption">—</figcaption>
      </figure>
      <div class="actions">
        <button class="btn" id="exportJSON">Export JSON</button>
        <button class="btn" id="exportCSV">Export CSV</button>
        <button class="btn" id="shareImage">Share Image</button>
        <button class="btn btn-ghost" id="backToLive">Back</button>
      </div>
    </div>
  </section>

  <!-- Toast -->
  <div id="errorToast" class="toast hidden" role="status" aria-live="polite"></div>

  <!-- Log viewer stays but no bottom dock -->
  <pre id="logViewer" class="log-viewer hidden"></pre>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js?v=15').then(r=>{try{r.update();}catch(e){}}).catch(()=>{});
    }
  </script>
</body>
</html>